### åä¸ªæ§½

> æœ€è¿‘å…¬å¸å…¶ä»–å›¢é˜Ÿåˆ†äº«äº†ä¸€ä¸ªç”Ÿäº§ bugï¼Œç”Ÿäº§ç¯å¢ƒæ¥å£åŸŸåæŒ‡å‘äº†æµ‹è¯•ç¯å¢ƒï¼ŒåŸå› å±…ç„¶æ˜¯*ä¸Šçº¿å¿˜è®°æ”¹ç”Ÿäº§é…ç½®*è¿™ç§ä½çº§é—®é¢˜ï¼Œå½“æ—¶æœ‰äº›è¯§å¼‚ï¼Œä¸ºä½•ä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Ÿ\
> å°±è¿™ä¸ªé—®é¢˜å…¶å®æ˜¯éœ€è¦åæ€ä¸€ä¸‹çš„ï¼Œ*ä¸ºä½•ä¸Šçº¿çš„æ—¶å€™ä¼šå¿˜è®°æ›´æ”¹é…ç½®ï¼Ÿ*æˆ–è€…è¯´è¿™ç§*æ‰‹åŠ¨æ”¹ä»£ç é…ç½®çš„æ–¹å¼æ˜¯å¦å¯å–ï¼Ÿ* \
> å¤§å¤šæ•°å…¬å¸åŸºæœ¬ä¸Šéƒ½æœ‰ä¸åŒçš„è¿è¡Œç¯å¢ƒï¼Œ_DEV_ã€_TEST_ã€_PRE_ã€_PROD_ ç­‰ï¼Œå¯¹äºä¸åŒç¯å¢ƒçš„ç»´æŠ¤å…¶å®ä¹Ÿæœ‰å¾ˆå¤šç§å¤„ç†æ–¹å¼ã€‚ä¸‹é¢æˆ‘ä»¬é’ˆå¯¹ä¸åŒå¤„ç†æ–¹å¼åšä¸€äº›æ€è€ƒï¼Ÿ

### æ€è€ƒ

#### ä¸åŒçš„å¤„ç†æ–¹å¼

1. å¸¸è§„çš„å¤„ç†æ–¹å¼ï¼Œé€šè¿‡æŸç§è§„åˆ™åˆ¤æ–­åŒºåˆ†ä»£ç ç¯å¢ƒ

![](./images/t_1.png)

```typescript
// è·å–ç¯å¢ƒæ ‡è¯†
const env = getCurrentEnv();

if (env === 'dev') {
  // do something
} else if (env === 'test') {
  // do something
} else if (env === 'prod') {
  // do something
}
```

> åˆ†æï¼š\
>
> 1. æ­¤ç§æ–¹å¼å¼ºä¾èµ– **getCurrentEnv** æ–¹æ³•åŒºåˆ†ç¯å¢ƒï¼Œè¿™é‡Œæ˜¯*é‡ç‚¹*ï¼›\
> 2. å¼ºä¾èµ– **if else** ä¸­å¯¹äºä¸åŒç¯å¢ƒçš„å¤„ç†é€»è¾‘ï¼›\
>
> ç¼ºç‚¹ï¼š\
>
> 1. ç¯å¢ƒåŒºåˆ†*å¼ºä¾èµ–ä»£ç é€»è¾‘*ï¼Œå¹¶ä¸”å„ä¸ª*ç¯å¢ƒé…ç½®ä»£ç å‡å­˜åœ¨äºæ„å»ºäº§ç‰©ä¸­*ï¼Œ\
> 2. ç¯å¢ƒåˆ¤æ–­éš”ç¦»ï¼Œå¾ˆéš¾å‘ç°å…¶ä»–ç¯å¢ƒä¸­çš„é—®é¢˜ï¼Œä»£ç å‡ºé”™æˆ–è€…æ”¹é”™ï¼Œä¸æ˜“å‘ç°ï¼›

2. `process.env.NODE_ENV` é€šè¿‡ node è¿è¡Œæ—¶ç¯å¢ƒå˜é‡æ„å»ºæ—¶åŒºåˆ†ä»£ç ç¯å¢ƒ

![](./images/t_2.png)

```typescript
// è·å–ç¯å¢ƒæ ‡è¯†
const env = process.env.NODE_ENV;

if (env === 'dev') {
  // do something
} else if (env === 'test') {
  // do something
} else if (env === 'prod') {
  // do something
}
```

> åˆ†æï¼š\
>
> 1. æ­¤æƒ…å†µä¾èµ–æ„å»ºè„šæœ¬ï¼Œä¸åŒç¯å¢ƒå¢åŠ æ„å»ºç¯å¢ƒå˜é‡ï¼Œä»¥æ­¤åŒºåˆ†ç¯å¢ƒ \
> 2. å…¶ä»–æƒ…å†µ*åŒä¸Šä¸€æ¡*
>
> ç¼ºç‚¹ï¼š\
>
> 1. éœ€è¦å¤šå®šåˆ¶ä¸€æ¬¡æ„å»ºè„šæœ¬ï¼ŒåŒºåˆ†ä¸åŒç¯å¢ƒï¼Œä¹Ÿå¯ä½¿ç”¨ `cross-env` è¿½åŠ ç¯å¢ƒè„šæœ¬ï¼›\
> 2. å…¶ä»–ç¼ºç‚¹*åŒä¸Šä¸€æ¡*

3. æ‹†åˆ†ç¯å¢ƒé…ç½®ä»£ç åˆ°ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡æ‰“åŒ…æ–¹å¼ï¼Œå›ºå®šåªè·å–æŸä¸ªç¯å¢ƒé…ç½®æ–‡ä»¶

![](./images/t_3.png)

```typescript
/** æ„å»ºè¿è¡Œæ—¶ç¯å¢ƒé…ç½® */
// $ cross-env ENV=test npm run build
// $ cross-env ENV=pre npm run build
// $ cross-env ENV=prod npm run build

// TESTï¼štest.config.js
// PREï¼štest.config.js
// PRODï¼šprod.config.js

// è¿™é‡Œéœ€è¦æ”¹é€ æ‰“åŒ…ä»£ç ï¼ŒåŠ¨æ€è¯»å–å¯¹åº”é…ç½®æ–‡ä»¶åˆ°æŸä¸ªå…¨å±€å˜é‡ä¸­
const env = process.env.ENV;
// åŠ¨æ€è¯»å–å¯¹åº”ç¯å¢ƒé…ç½®æ–‡ä»¶
const config = require(`./config/${env}.config.js`);

// todo é€šè¿‡ç¼–å†™æ„å»ºä»£ç åŠ¨æ€æ·»åŠ åˆ°å…¨å±€å˜é‡ä¸­
```

> åˆ†æï¼š\
>
> 1. æ­¤ç§æƒ…å†µéš”ç¦»äº†ä¸åŒç¯å¢ƒé…ç½®ï¼Œæ„å»ºäº§ç‰©ä»…å­˜åœ¨å½“å‰ç¯å¢ƒçš„ä»£ç é…ç½®ï¼Œæ— å†—ä½™ï¼›\
> 2. ä¸€æ¬¡ç¼–å†™æ„å»ºé…ç½®ï¼Œæ°¸ä¹…ç”Ÿæ•ˆï¼Œä»…éœ€è¦ç»´æŠ¤ä¸åŒç¯å¢ƒé…ç½®æ–‡ä»¶å³å¯ï¼Œäº’ä¸å¹²æ‰°ï¼›\
>
> ç¼ºç‚¹ï¼š\
>
> 1. éœ€è¦å®šåˆ¶æ„å»ºä»£ç ï¼ŒåŠ¨æ€è·å–é…ç½®åˆ°å…¨å±€å˜é‡ä¸­ï¼Œç¼–å†™æˆæœ¬è¾ƒé«˜ï¼›\
> 2. ä¸åˆ©äºè¿è¡Œæ—¶ç¯å¢ƒé…ç½®å˜æ›´ï¼Œæ¯æ¬¡æ”¹åŠ¨é…ç½®éœ€è¦é‡å¯æ„å»ºè„šæœ¬ï¼›

4. æ‹†åˆ†ç¯å¢ƒé…ç½®ä»£ç åˆ°ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡åŠ¨æ€ç”Ÿæˆå„ä¸ªç¯å¢ƒé…ç½®æ–‡ä»¶åˆ°æœ¬åœ°å›ºå®šä»£ç æ–‡ä»¶ä¸­ï¼Œåœ¨å…¶ä»–ä¸šåŠ¡ä»£ç ä¸­å›ºå®šå¼•ç”¨æ­¤æ–‡ä»¶

![](./images/t_4.png)

```typescript
/** 1. å®šåˆ¶è„šæœ¬åŠ¨æ€ç”Ÿæˆå›ºå®šé…ç½®æ–‡ä»¶ï¼Œæ­¤å¤„éœ€è¦å®šåˆ¶ config è„šæœ¬ï¼Œ*.config.js ä¸ºç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œ-s å¯¹åº”æºæ–‡ä»¶ï¼Œ-o å¯¹åº”è¾“å‡ºæ–‡ä»¶ */
// $ config -e dev -s ./config/dev.config.js -o src/config.js
// $ config -e test -s ./config/test.config.js -o src/config.js
// $ config -e prod -s ./config/prod.config.js -o src/config.js

// è¯»å–ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
import config from './config.js';
```

> åˆ†æï¼š\
>
> 1. æ­¤æƒ…å†µå”¯ä¸€çš„éš¾ç‚¹åœ¨äº*å®šåˆ¶è„šæœ¬åŠ¨æ€ç”Ÿæˆä¸åŒçš„ç¯å¢ƒé…ç½®æ–‡ä»¶*ï¼›\
> 2. ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä¸å…¶ä»–ç¯å¢ƒè§£è€¦ï¼Œä¸”çº¯ç²¹æ— å†—ä½™ï¼Œå¹¶ä¸”æœ‰è‰¯å¥½çš„è¿è¡Œæ—¶æ”¯æŒï¼›
>
> ç¼ºç‚¹ï¼š\
>
> 1. å®šåˆ¶è„šæœ¬æœ‰äº›éš¾åº¦

#### æ€è·¯å°ç»“

> ç»¼ä¸Šæ€»ç»“ï¼Œä¸ºäº†è§£å†³å†—ä½™é—®é¢˜ã€ç¯å¢ƒå¹²æ‰°é—®é¢˜ã€ç»´æŠ¤å˜æ›´é—®é¢˜ã€æ„å»ºè¿è¡Œæ—¶é—®é¢˜ç­‰ç­‰ï¼Œæˆ‘æ¯”è¾ƒæ¨èç¬¬ 4 ç§æ–¹å¼ï¼Œè™½ç„¶æœ‰äº›å®šåˆ¶éš¾åº¦ï¼Œä¸è¿‡æ‹†è§£ä¸‹å®ç°æ€è·¯ï¼Œå…¶å®è¿˜æ˜¯æœ‰è¿¹å¯å¾ªçš„ï¼š
>
> 1. å®šåˆ¶ä¸€ä¸ª*è„šæœ¬*å…¥å£ï¼Œå¯ä»¥*è¯»å–å‘½ä»¤è¡Œä¸­å®šä¹‰çš„å…¥å‚*ï¼›
> 2. *åŠ¨æ€è¯»å–*é…ç½®æ–‡ä»¶ï¼Œå¹¶*é‡å†™é…ç½®æ–‡ä»¶*åˆ°å›ºå®šæ–‡ä»¶ä¸­ï¼›
> 3. åº”ç”¨ï¼›
>
> ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€æ­¥ä¸€æ­¥å®ç°è¯¥æ€è·¯

### å®ç°

> ä¸‹é¢è®©æˆ‘ä»¬æ¥å®ç°æ­¤åŠŸèƒ½

![](./images/t_4.png)

#### 1. å®šåˆ¶è„šæœ¬å…¥å£

> è¿™é‡Œéœ€è¦å®Œæˆå‡ ä¸ªåŠŸèƒ½ç‚¹ï¼š
>
> 1. æŒ‡å®šå…¥å£è„šæœ¬æ–‡ä»¶
> 2. èƒ½å¤Ÿè§£æè„šæœ¬å…¥å‚

1. åˆ›å»ºä¸€ä¸ª config.js

```typescript
console.log('> config å…¥å£');
console.log('> ', process.argv); // æ‰“å°å…¥å‚
```

2. è§£æè„šæœ¬å…¥å‚ï¼Œæ¯”å¦‚æ‰§è¡Œ `node ./lib/config.js -e dev -o dist/config.js`

```bash
> node ./lib/config.js -e dev -o dist/config.js

> config å…¥å£
>  [
  '/usr/local/bin/node',
  '/Users/fosunhealth/Documents/ME/learning-tools/packages/config/lib/config.js',
  '-e',
  'dev',
  '-o',
  'dist/config.js'
]
```

> è§‚å¯Ÿä»¥ä¸Šæ‰“å°å³å¯æ ¹æ®å‡ºå‚åŒ¹é…è„šæœ¬å…¥å‚è§„åˆ™ï¼Œè¯»å–åˆ°è‡ªå·±æƒ³è¦çš„å‚æ•°

- 3. è¿™é‡Œæ¨èä¸‹ `commander` å·¥å…·ï¼Œå°è£…äº†å¾ˆå¤šè¾…åŠ©åŠŸèƒ½ï¼Œå¯ä»¥å·ä¸ªæ‡’

```typescript
const program = require('commander');
const { version } = require('../package.json');

program
  .version(version)
  //   .command('config') // è¿™é‡Œç”¨ä½œæŒ‡å®šè„šæœ¬åç§°ï¼Œè°ƒè¯•é˜¶æ®µå¯å…ˆæ³¨é‡Š
  .usage('-e <env> -o <output>')
  .description('ğŸˆ ç”Ÿæˆé…ç½®æ–‡ä»¶')
  .option('-e, --env <env>', 'å½“å‰ç¯å¢ƒ')
  .option('-o, --output <output>', 'è¾“å‡ºè·¯å¾„')

  .action(({ output, env }) => {
    console.log('> å½“å‰ç¯å¢ƒ', env);
    console.log('> è¾“å‡ºè·¯å¾„', output);
  });

// è§£æè„šæœ¬å…¥å‚
program.parse(process.argv);
```

> æ­¤æ—¶å†æ‰§è¡Œè„šæœ¬ï¼Œå¾—åˆ°è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
>
> å¾—åˆ°äº†æˆ‘ä»¬éœ€è¦æŒ‡å®šçš„ç¯å¢ƒå˜é‡ï¼Œä»¥åŠéœ€è¦è¾“å‡ºçš„è·¯å¾„ï¼Œè¿™é˜¶æ®µå®£å‘Šå®Œæˆ

```bash
> node ./lib/config.js -e dev -o dist/config.js

> å½“å‰ç¯å¢ƒ dev
> è¾“å‡ºè·¯å¾„ dist/config.js
```

#### 2. åŠ¨æ€è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆåˆ°å›ºå®šæ–‡ä»¶

> æ¥ä¸Šä¸€æ­¥ï¼Œæ­¤é˜¶æ®µéœ€è¦å¤„ç†å…¥å‚å¹¶åŠ¨æ€è¾“å‡ºé…ç½®æ–‡ä»¶ï¼š
>
> 1. æ ¹æ® _env_ **è¯»å–**å¯¹åº”é…ç½®æ–‡ä»¶å†…å®¹
> 2. **å†™å…¥**åˆ°å›ºå®šæ–‡ä»¶ä¸­

![](./images/t_6.png)

```typescript
// æ–‡ä»¶å¤„ç†å·¥å…·
const { existsSync, outputFileSync, mkdirSync, writeFileSync } = require('fs-extra');

/** è‡ªå®šä¹‰è§„åˆ™è¯»å–æœ¬åœ°çš„é…ç½®æ–‡ä»¶ */
const rootPath = process.cwd(); // å½“å‰ä¸Šä¸‹æ–‡æ ¹è·¯å¾„ï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼Œéœ€è¦åŸºäºå½“å‰ä¸Šä¸‹æ–‡å»å¯»æ‰¾æ–‡ä»¶
const configPath = join(rootPath, `./config/${env}.config.js`); // æœ¬åœ°ç¯å¢ƒé…ç½®æ–‡ä»¶
const outputPath = join(rootPath, output || './src/config.ts'); // ç”Ÿæˆé…ç½®è·¯å¾„

if (!existsSync(configPath)) {
  throw new Error(`${env} ç¯å¢ƒé…ç½®æ–‡ä»¶ä¸å­˜åœ¨`);
}

try {
  // è¯»å–é…ç½®å†…å®¹
  const content = readFileSync(configPath, { encoding: 'utf-8' });
  // å†™å…¥é…ç½®å†…å®¹
  writeFileSync(outputPath, content, { encoding: 'utf-8' });

  console.log('> ç”Ÿæˆé…ç½®æ–‡ä»¶æˆåŠŸ.');
} catch (error) {
  console.error('> ç”Ÿæˆé…ç½®æ–‡ä»¶å¼‚å¸¸', error);
}
```

> å¦‚ä¸‹å›¾æ‰§è¡Œæµç¨‹ï¼Œå³å¯åŠ¨æ€ç”Ÿæˆæ‰€éœ€ç¯å¢ƒé…ç½®äº†
>
> 1. è¿™æ ·å®ç°å…·ä½“çš„é…ç½®æ–‡ä»¶è¯»å–è§„åˆ™å°±å¯ä»¥è‡ªå®šä¹‰æ‹‰ï¼Œä¹Ÿèƒ½åœ¨*ä¸šåŠ¡ä»£ç æ„å»ºè¿‡ç¨‹ä¸­åŠ¨æ€ç”Ÿæˆ*äº†
> 2. ä½¿ç”¨æ–¹å¼è¿˜å¯ä»¥é€šè¿‡*å°è£…åˆ°ç§åº“ä¸­*ï¼Œé€šè¿‡è„šæœ¬å¼•ç”¨ï¼Œè¿™æ ·å°±èƒ½å½“åšä¸€ä¸ª*å›¢é˜Ÿå·¥å…·*ä½¿ç”¨äº†
>
> æºç å‚è€ƒï¼šhttps://github.com/howieyi/learning-tools/tree/master/packages/config

![](./images/t_5.png)

### å°ç»“

> æœ¬æ–‡åå‘æ€è·¯å‹ï¼Œä¸»è¦ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªå…¬å¸ä¸šåŠ¡å¸¸è§çš„åœºæ™¯ï¼Œå¹¶æœªå±•å¼€ç›¸å…³çš„ä¸šåŠ¡å»¶å±•æ€§ï¼Œä¸»è¦è¿˜æ˜¯éœ€è¦æ ¹æ®å…¬å¸ç‹¬æœ‰çš„ä¸šåŠ¡æ¥å®šæ€§ï¼› \
> æœ¬æ–‡å‡å±*ä¸ªäººè§è§£*ï¼Œå¦‚æœ‰ä¸å¯¹çš„çƒ¦è¯·æŒ‡å‡º; \
> å¦‚æœ‰å¸®åŠ©çš„ï¼Œé“å­ä»¬åŠ¨åŠ¨å°æ‰‹ï¼Œ*åŠ ä¸ªå‰ç«¯æŠ€æœ¯ç¾¤*å’±ä»¬ä¸€èµ·*æ¢è®¨å‰ç«¯æŠ€æœ¯é—®é¢˜*~~~

![](https://files.mdnice.com/user/5404/03f6ccde-7ac5-4ec9-a4d8-7283425eeb61.png)
